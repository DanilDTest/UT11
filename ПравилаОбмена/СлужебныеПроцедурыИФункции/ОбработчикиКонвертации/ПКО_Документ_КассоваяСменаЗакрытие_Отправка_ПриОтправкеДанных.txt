Процедура ПКО_Документ_КассоваяСменаЗакрытие_Отправка_ПриОтправкеДанных(ДанныеИБ, ДанныеXDTO, КомпонентыОбмена, СтекВыгрузки)
	ИмяПКО = "Справочник_КассыККМ_Отправка";
	
	Если СтекВыгрузки.Количество() > 1 Тогда
		Если ЗначениеЗаполнено(ДанныеИБ.КассаККМ) Тогда
			КассаККМ = ДанныеИБ.КассаККМ;
		Иначе
			КассаККМФискальноеУстройство = КассаККМФискальноеУстройство(ДанныеИБ.ФискальноеУстройство);
			КассаККМ = КассаККМФискальноеУстройство.КассаККМ;
		КонецЕсли;	
		ДанныеXDTO.Вставить("КассаККМ", Новый Структура("Значение, ИмяПКО", КассаККМ, ИмяПКО));
		Возврат;
	КонецЕсли;
	
	КассаККМ = ДанныеИБ.ДополнительныеСвойства.КассаККМ;
	
	ДанныеXDTO.КлючевыеСвойства.Вставить("КассаККМ", Новый Структура("Значение, ИмяПКО", КассаККМ, ИмяПКО));
	Валюта = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(КассаККМ, "ВалютаДенежныхСредств");
	ДанныеXDTO.Вставить("Валюта", Новый Структура("Значение, ИмяПКО", Валюта, "Справочник_Валюты"));
	
	//Найдем отчет о розничных продажах
	ОтчетОРозничныхПродажах = Неопределено;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	ОтчетОРозничныхПродажах.Ссылка КАК Ссылка
	|ИЗ
	|	Документ.ОтчетОРозничныхПродажах КАК ОтчетОРозничныхПродажах
	|ГДЕ
	|	ОтчетОРозничныхПродажах.КассоваяСмена = &КассоваяСмена";
	
	Запрос.УстановитьПараметр("КассоваяСмена", ДанныеИБ.Ссылка);
	
	Результат = Запрос.Выполнить();
	Выборка = Результат.Выбрать();
	
	Если Выборка.Следующий() Тогда
		ОтчетОРозничныхПродажах = Выборка.Ссылка;
		ДанныеXDTO.Вставить("Сумма", ОтчетОРозничныхПродажах.СуммаДокумента);
		ДанныеXDTO.Вставить("Кассир", Новый Структура("Значение, ИмяПКО", ОтчетОРозничныхПродажах.Ответственный, "Справочник_Пользователи"));
	КонецЕсли;
КонецПроцедуры
