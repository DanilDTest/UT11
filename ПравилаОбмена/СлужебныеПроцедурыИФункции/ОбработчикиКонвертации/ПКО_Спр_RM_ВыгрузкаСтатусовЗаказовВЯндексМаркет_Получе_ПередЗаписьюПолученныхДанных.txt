Процедура ПКО_Спр_RM_ВыгрузкаСтатусовЗаказовВЯндексМаркет_Получе_ПередЗаписьюПолученныхДанных(ПолученныеДанные, ДанныеИБ, КонвертацияСвойств, КомпонентыОбмена)
	Документ_ЗаказКлиента_Получение = RM_ОбменДаннымиXDTOСервер.ПКОПоИмени(КомпонентыОбмена,"Документ_ЗаказКлиента_Получение");
	Перечисления_СтатусыОтправленийOZON = КомпонентыОбмена.ПравилаКонвертацииПредопределенныхДанных.Найти("Перечисление_RM_СтатусыОтправленийOZON", "ИмяПКПД");
	
	
	СтруктураИзмеренийРегистра = Новый Структура;
	СтруктураИзмеренийРегистра.Вставить("НомерЗаказа");
	СтруктураИзмеренийРегистра.Вставить("Период");
	
	
	Для Каждого ИзмерениеРегистра из СтруктураИзмеренийРегистра Цикл
		Значение = ПолученныеДанные.ДополнительныеСвойства[ИзмерениеРегистра.Ключ];
		
		Если Значение = Неопределено Тогда
			Продолжить;
		ИначеЕсли ТипЗнч(Значение) = Тип("Структура") Тогда
			
			Если ИзмерениеРегистра.Ключ = "ЗаказКлиента" Тогда
				ПКО = Документ_ЗаказКлиента_Получение;
			КонецЕсли;
			
			Значение = RM_ОбменДаннымиXDTOСервер.СтруктураОбъектаXDTOВДанныеИБ(КомпонентыОбмена, 
				Значение, 
				ПКО, 
				"ПолучитьСсылку").Ссылка;		
		КонецЕсли;
	
		 ПолученныеДанные.Отбор[ИзмерениеРегистра.Ключ].Значение = Значение;
		 ПолученныеДанные.Отбор[ИзмерениеРегистра.Ключ].Использование = Истина;
	КонецЦикла;
	       
	СтруктураСсылочныхПолей = Новый Структура;
	СтруктураСсылочныхПолей.Вставить("ЗаказКлиента");
		
	// Добавление записей в набор записей.		
	Если ПолученныеДанные.ДополнительныеСвойства.Записи <> Неопределено Тогда
		
		мВыгрузкаСтатусовЗаказовВЯндексМаркет = ПолученныеДанные.Метаданные();
		
		ТаблицаДанных = Новый ТаблицаЗначений;
		Для Каждого Реквизит Из мВыгрузкаСтатусовЗаказовВЯндексМаркет.СтандартныеРеквизиты Цикл
			ТаблицаДанных.Колонки.Добавить(Реквизит.Имя, Реквизит.Тип);	
		КонецЦикла;
		
		Для Каждого Реквизит Из мВыгрузкаСтатусовЗаказовВЯндексМаркет.Измерения Цикл
			ТаблицаДанных.Колонки.Добавить(Реквизит.Имя, Реквизит.Тип);	
		КонецЦикла;
		
		Для Каждого Реквизит Из мВыгрузкаСтатусовЗаказовВЯндексМаркет.Ресурсы Цикл
			ТаблицаДанных.Колонки.Добавить(Реквизит.Имя, Реквизит.Тип);	
		КонецЦикла;
		
		Для Каждого Реквизит Из мВыгрузкаСтатусовЗаказовВЯндексМаркет.Реквизиты Цикл
			ТаблицаДанных.Колонки.Добавить(Реквизит.Имя, Реквизит.Тип);	
		КонецЦикла;
		
		Для Каждого Запись Из ПолученныеДанные.ДополнительныеСвойства.Записи Цикл
			
			НоваяСтрокаДанных				= ТаблицаДанных.Добавить();
			НоваяСтрокаДанных.Период		= Запись.Период;  
			НоваяСтрокаДанных.НомерЗаказа	= Запись.НомерЗаказа;   
			НоваяСтрокаДанных.Статус		= Перечисления_СтатусыОтправленийOZON.КонвертацииЗначенийПриПолучении.Получить(Запись.Статус.Значение); 
			НоваяСтрокаДанных.Отправлено	= Запись.Отправлено;
			НоваяСтрокаДанных.Ошибка		= Запись.Ошибка;
			НоваяСтрокаДанных.Ответ			= Запись.Ответ;
					
			Для Каждого ИзмерениеРегистра из СтруктураСсылочныхПолей Цикл
				
				Значение = Запись[ИзмерениеРегистра.Ключ];
				
				Если ТипЗнч(Значение) = Тип("Структура") Тогда
					
					Если ИзмерениеРегистра.Ключ = "ЗаказКлиента" Тогда
						ПКО = Документ_ЗаказКлиента_Получение;
					КонецЕсли;
					
					Значение = RM_ОбменДаннымиXDTOСервер.СтруктураОбъектаXDTOВДанныеИБ(КомпонентыОбмена, 
						Значение, 
						ПКО, 
						"ПолучитьСсылку").Ссылка;	
					
				КонецЕсли;
					
				НоваяСтрокаДанных[ИзмерениеРегистра.Ключ] = Значение;
	
			КонецЦикла;
						
		КонецЦикла;
		
		// Исключаем затирание данных неподлежащих обмену
		Запрос = Новый Запрос;
		Запрос.Текст = 
		"ВЫБРАТЬ
		|	ТаблицаДанных.Период КАК Период,
		|	ТаблицаДанных.НомерЗаказа КАК НомерЗаказа,
		|	ТаблицаДанных.ЗаказКлиента КАК ЗаказКлиента,
		|	ТаблицаДанных.Статус КАК Статус,
		|	ТаблицаДанных.Отправлено КАК Отправлено,
		|	ТаблицаДанных.Ошибка КАК Ошибка,
		|	ТаблицаДанных.Ответ КАК Ответ
		|ПОМЕСТИТЬ ВТДанные
		|ИЗ
		|	&ТаблицаДанных КАК ТаблицаДанных
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ВТДанные.Период КАК Период,
		|	ВТДанные.НомерЗаказа КАК НомерЗаказа,
		|	ВТДанные.ЗаказКлиента КАК ЗаказКлиента,
		|	ВТДанные.Статус КАК Статус,
		|	ЕСТЬNULL(ДанныеИБ.Отправлено, ВТДанные.Отправлено) КАК Отправлено,
		|	ЕСТЬNULL(ДанныеИБ.Ошибка, ВТДанные.Ошибка) КАК Ошибка,
		|	ЕСТЬNULL(ДанныеИБ.Ответ, ВТДанные.Ответ) КАК Ответ
		|ИЗ
		|	ВТДанные КАК ВТДанные
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.RM_ВыгрузкаСтатусовЗаказовВЯндексМаркет КАК ДанныеИБ
		|		ПО ВТДанные.Период = ДанныеИБ.Период
		|			И ВТДанные.ЗаказКлиента = ДанныеИБ.ЗаказКлиента";
		
		Запрос.УстановитьПараметр("ТаблицаДанных",	ТаблицаДанных);
		
		ТаблицаДанных = Запрос.Выполнить().Выгрузить();
		ПолученныеДанные.Загрузить(ТаблицаДанных);
			
	КонецЕсли;
КонецПроцедуры
