Процедура ПКО_Документ_КорректировкаРеализации_Отправка_ПриОтправкеДанных(ДанныеИБ, ДанныеXDTO, КомпонентыОбмена, СтекВыгрузки)
	Если СтекВыгрузки.Количество() > 1 Тогда
		Возврат;
	КонецЕсли;
	
	ВыгрузитьНалогообложениеНДС(КомпонентыОбмена, ДанныеИБ, ДанныеXDTO, Ложь, Ложь);
	
	ВыгрузитьДополнительныеРеквизитыИСведения(КомпонентыОбмена, ДанныеИБ, ДанныеXDTO);
	
	// Данные исходного документа реализации
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	Док.ЗаказКлиента,
	|	Док.ВернутьМногооборотнуюТару КАК ВернутьМногооборотнуюТару
	|ПОМЕСТИТЬ ДанныеДокументаРеализации
	|ИЗ
	|	Документ.РеализацияТоваровУслуг КАК Док
	|ГДЕ
	|	Док.Ссылка = &ДокументОснование
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Док.ЗаказКлиента,
	|	ЛОЖЬ
	|ИЗ
	|	Документ.АктВыполненныхРабот КАК Док
	|ГДЕ
	|	Док.Ссылка = &ДокументОснование
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Док.ЗаказКлиента.Ссылка КАК Ссылка,
	|	Док.ЗаказКлиента.Дата КАК Дата,
	|	Док.ЗаказКлиента.Организация КАК Организация,
	|	Док.ЗаказКлиента.Номер КАК Номер
	|ИЗ
	|	ДанныеДокументаРеализации КАК Док";
	
	// Ссылка на исправляемый документ
	
	ТекстЗапроса = ТекстЗапроса + ОбщегоНазначения.РазделительПакетаЗапросов() +
	"ВЫБРАТЬ
	|	Док.Ссылка,
	|	Док.МоментВремени,
	|	ЛОЖЬ КАК ЭтоДокументОснование
	|ПОМЕСТИТЬ ПоследовательностьДокументов
	|ИЗ
	|	Документ.КорректировкаРеализации КАК Док
	|ГДЕ
	|	Док.ДокументОснование = &ДокументОснование
	|	И Док.МоментВремени <= &МоментВремени
	|	И Док.Проведен
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Док.ДокументОснование,
	|	Док.ДокументОснование.МоментВремени,
	|	ИСТИНА
	|ИЗ
	|	Документ.КорректировкаРеализации КАК Док
	|ГДЕ
	|	Док.Ссылка = &Ссылка
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Док.Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ПоследовательностьДокументов.Ссылка,
	|	ПоследовательностьДокументов.МоментВремени,
	|	ПоследовательностьДокументов.ЭтоДокументОснование,
	|	МАКСИМУМ(ВЫБОР
	|			КОГДА СчетФактураВыданный.Ссылка ЕСТЬ NULL 
	|				ТОГДА ЛОЖЬ
	|			ИНАЧЕ ИСТИНА
	|		КОНЕЦ) КАК Корректировочный
	|ПОМЕСТИТЬ ПараметрыДокументовПоследовательности
	|ИЗ
	|	ПоследовательностьДокументов КАК ПоследовательностьДокументов
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный КАК СчетФактураВыданный
	|		ПО ПоследовательностьДокументов.Ссылка = СчетФактураВыданный.ДокументОснование
	|			И (СчетФактураВыданный.Корректировочный)
	|			И (НЕ СчетФактураВыданный.ПометкаУдаления)
	|
	|СГРУППИРОВАТЬ ПО
	|	ПоследовательностьДокументов.Ссылка,
	|	ПоследовательностьДокументов.МоментВремени,
	|	ПоследовательностьДокументов.ЭтоДокументОснование
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	ПоследовательностьДокументов.Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Параметры1.Ссылка,
	|	Параметры1.Корректировочный,
	|	МИНИМУМ(ВЫБОР
	|			КОГДА Параметры1.Корректировочный
	|					И НЕ Параметры2.Корректировочный
	|				ТОГДА ИСТИНА
	|			ИНАЧЕ ЛОЖЬ
	|		КОНЕЦ) КАК ИсходныйКорректировочный
	|ПОМЕСТИТЬ ПараметрыОтбора
	|ИЗ
	|	ПараметрыДокументовПоследовательности КАК Параметры1
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПараметрыДокументовПоследовательности КАК Параметры2
	|		ПО (Параметры1.Ссылка = &Ссылка)
	|			И (Параметры2.Ссылка <> &Ссылка)
	|
	|СГРУППИРОВАТЬ ПО
	|	Параметры1.Ссылка,
	|	Параметры1.Корректировочный
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Параметры1.Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	ИсправляемыеДокументы.Ссылка,
	|	ИсправляемыеДокументы.МоментВремени
	|ПОМЕСТИТЬ ИсправляемыйДокумент
	|ИЗ
	|	ПараметрыДокументовПоследовательности КАК ИсправляемыеДокументы
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПараметрыОтбора КАК ПараметрыОтбора
	|		ПО (ИсправляемыеДокументы.Корректировочный = ПараметрыОтбора.Корректировочный
	|				ИЛИ ПараметрыОтбора.ИсходныйКорректировочный
	|				ИЛИ ИсправляемыеДокументы.ЭтоДокументОснование)
	|			И ИсправляемыеДокументы.Ссылка <> ПараметрыОтбора.Ссылка
	|
	|УПОРЯДОЧИТЬ ПО
	|	ИсправляемыеДокументы.МоментВремени УБЫВ
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ИсправляемыйДокумент.Ссылка КАК Ссылка,
	|	ИсправляемыйДокумент.Ссылка.Дата КАК Дата,
	|	ИсправляемыйДокумент.Ссылка.Организация КАК Организация,
	|	ИсправляемыйДокумент.Ссылка.Номер КАК Номер
	|ИЗ
	|	ИсправляемыйДокумент КАК ИсправляемыйДокумент";
	
	// Вид операции
	
	ТекстЗапроса = ТекстЗапроса + ОбщегоНазначения.РазделительПакетаЗапросов() +
	"ВЫБРАТЬ
	|	ПараметрыОтбора.ИсходныйКорректировочный
	|ИЗ
	|	ПараметрыОтбора";
	
	// Ссылка на основание исправления (корректировки) и документ до корректировки
	
	ТекстЗапроса = ТекстЗапроса + ОбщегоНазначения.РазделительПакетаЗапросов() +
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	ИсправляемыеДокументы.Ссылка КАК Ссылка,
	|	ИсправляемыеДокументы.Ссылка.Дата КАК Дата,
	|	ИсправляемыеДокументы.Ссылка.Организация КАК Организация,
	|	ИсправляемыеДокументы.Ссылка.Номер КАК Номер
	|ИЗ
	|	ПараметрыДокументовПоследовательности КАК ИсправляемыеДокументы
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПараметрыОтбора КАК ПараметрыОтбора
	|		ПО (ИсправляемыеДокументы.Корректировочный = ПараметрыОтбора.Корректировочный
	|				ИЛИ ИсправляемыеДокументы.ЭтоДокументОснование)
	
	|			И ИсправляемыеДокументы.Ссылка <> ПараметрыОтбора.Ссылка
	|
	|УПОРЯДОЧИТЬ ПО
	|	ИсправляемыеДокументы.ЭтоДокументОснование,
	|	ИсправляемыеДокументы.МоментВремени
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ ПЕРВЫЕ 1
	|	ИсправляемыеДокументы.Ссылка,
	|	ИсправляемыеДокументы.МоментВремени
	|ПОМЕСТИТЬ ДокументДоКорректировки
	|ИЗ
	|	ПараметрыДокументовПоследовательности КАК ИсправляемыеДокументы
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПараметрыОтбора КАК ПараметрыОтбора
	|		ПО ПараметрыОтбора.Корректировочный И Не ПараметрыОтбора.ИсходныйКорректировочный
	|			И ИсправляемыеДокументы.Корректировочный = Ложь
	|			И ИсправляемыеДокументы.Ссылка <> ПараметрыОтбора.Ссылка
	|
	|УПОРЯДОЧИТЬ ПО
	|	ИсправляемыеДокументы.ЭтоДокументОснование,
	|	ИсправляемыеДокументы.МоментВремени УБЫВ";
	
	// Товары исходной реализации
	
	ТекстЗапроса = ТекстЗапроса + ОбщегоНазначения.РазделительПакетаЗапросов() +
	"ВЫБРАТЬ
	|	Товары.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|	Товары.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|	Товары.АналитикаУчетаНоменклатуры.Серия КАК Серия,
	|	Товары.СтавкаНДС КАК СтавкаНДС,
	|	Товары.НомерГТД КАК НомерГТД,
	|	Товары.ВидЗапасов.ТипЗапасов КАК ТипЗапасов,
	|	СУММА(Товары.Количество) КАК Количество,
	|	СУММА(Товары.СуммаСНДС) КАК СуммаСНДС,
	|	СУММА(Товары.СуммаНДС) КАК СуммаНДС
	|ПОМЕСТИТЬ ТоварыИсходнойРеализации
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.ВидыЗапасов КАК Товары
	|ГДЕ
	|	Товары.Ссылка = &ДокументОснование
	|	И (Товары.АналитикаУчетаНоменклатуры.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Товар)
	|			ИЛИ Товары.АналитикаУчетаНоменклатуры.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара)
	|				И НЕ Товары.Ссылка.ВернутьМногооборотнуюТару)
	|
	|СГРУППИРОВАТЬ ПО
	|	Товары.АналитикаУчетаНоменклатуры.Номенклатура,
	|	Товары.АналитикаУчетаНоменклатуры.Характеристика,
	|	Товары.СтавкаНДС,
	|	Товары.НомерГТД,
	|	Товары.ВидЗапасов.ТипЗапасов,
	|	Товары.АналитикаУчетаНоменклатуры.Серия";
	
	// Изменения в товарах
	
	ТекстЗапроса = ТекстЗапроса + ОбщегоНазначения.РазделительПакетаЗапросов() +
	"ВЫБРАТЬ
	|	КорректировкаВыручки.Ссылка КАК Ссылка,
	|	КорректировкаВыручки.АналитикаУчетаНоменклатуры.Номенклатура КАК Номенклатура,
	|	КорректировкаВыручки.АналитикаУчетаНоменклатуры.Характеристика КАК Характеристика,
	|	КорректировкаВыручки.АналитикаУчетаНоменклатуры.Серия КАК Серия,
	|	КорректировкаВыручки.НомерГТД КАК НомерГТД,
	|	КорректировкаВыручки.СтавкаНДС КАК СтавкаНДС,
	|	КорректировкаВыручки.ВидЗапасов.ТипЗапасов КАК ТипЗапасов,
	|	0 КАК Количество,
	|	КорректировкаВыручки.СуммаНДС КАК СуммаНДС,
	|	КорректировкаВыручки.СуммаСНДС КАК СуммаСНДС
	|ПОМЕСТИТЬ ИзмененияВТоварахНеФильтрованные
	|ИЗ
	|	Документ.КорректировкаРеализации.ВидыЗапасовКорректировкаВыручки КАК КорректировкаВыручки,
	|	ДанныеДокументаРеализации КАК ДанныеДокументаРеализации
	|ГДЕ
	|	(КорректировкаВыручки.АналитикаУчетаНоменклатуры.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Товар)
	|			ИЛИ КорректировкаВыручки.АналитикаУчетаНоменклатуры.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара)
	|				И НЕ ДанныеДокументаРеализации.ВернутьМногооборотнуюТару)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ТоварыКОприходованию.Ссылка,
	|	ТоварыКОприходованию.АналитикаУчетаНоменклатуры.Номенклатура,
	|	ТоварыКОприходованию.АналитикаУчетаНоменклатуры.Характеристика,
	|	ТоварыКОприходованию.АналитикаУчетаНоменклатуры.Серия,
	|	ТоварыКОприходованию.НомерГТД,
	|	ТоварыКОприходованию.СтавкаНДС,
	|	ТоварыКОприходованию.ВидЗапасов.ТипЗапасов,
	|	-ТоварыКОприходованию.Количество,
	|	-ТоварыКОприходованию.СуммаНДС,
	|	-ТоварыКОприходованию.СуммаСНДС
	|ИЗ
	|	Документ.КорректировкаРеализации.ВидыЗапасовОприходование КАК ТоварыКОприходованию,
	|	ДанныеДокументаРеализации КАК ДанныеДокументаРеализации
	|ГДЕ
	|	(ТоварыКОприходованию.АналитикаУчетаНоменклатуры.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Товар)
	|			ИЛИ ТоварыКОприходованию.АналитикаУчетаНоменклатуры.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара)
	|				И НЕ ДанныеДокументаРеализации.ВернутьМногооборотнуюТару)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ТоварыКСписанию.Ссылка,
	|	ТоварыКСписанию.АналитикаУчетаНоменклатуры.Номенклатура,
	|	ТоварыКСписанию.АналитикаУчетаНоменклатуры.Характеристика,
	|	ТоварыКСписанию.АналитикаУчетаНоменклатуры.Серия,
	|	ТоварыКСписанию.НомерГТД,
	|	ТоварыКСписанию.СтавкаНДС,
	|	ТоварыКСписанию.ВидЗапасов.ТипЗапасов,
	|	ТоварыКСписанию.Количество,
	|	ТоварыКСписанию.СуммаНДС,
	|	ТоварыКСписанию.СуммаСНДС
	|ИЗ
	|	Документ.КорректировкаРеализации.ВидыЗапасовСписание КАК ТоварыКСписанию,
	|	ДанныеДокументаРеализации КАК ДанныеДокументаРеализации
	|ГДЕ
	|	(ТоварыКСписанию.АналитикаУчетаНоменклатуры.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Товар)
	|			ИЛИ ТоварыКСписанию.АналитикаУчетаНоменклатуры.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара)
	|				И НЕ ДанныеДокументаРеализации.ВернутьМногооборотнуюТару)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	КорректировкаВыручки.Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Изменения.Номенклатура КАК Номенклатура,
	|	Изменения.Характеристика КАК Характеристика,
	|	Изменения.Серия КАК Серия,
	|	Изменения.НомерГТД КАК НомерГТД,
	|	Изменения.СтавкаНДС КАК СтавкаНДС,
	|	Изменения.ТипЗапасов КАК ТипЗапасов,
	|	Изменения.Количество КАК Количество,
	|	Изменения.СуммаНДС КАК СуммаНДС,
	|	Изменения.СуммаСНДС КАК СуммаСНДС,
	|	ВЫБОР
	|		КОГДА НЕ Последовательность.Корректировочный
	|				И Последовательность.МоментВремени <= ДокументДоКорректировки.МоментВремени
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ИзмененияДоКорректировки,
	|	ВЫБОР
	|		КОГДА Последовательность.МоментВремени <= ИсправляемыйДокумент.МоментВремени
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ КАК ИзмененияДоИсправления
	|ПОМЕСТИТЬ ИзмененияВТоварах
	|ИЗ
	|	ИзмененияВТоварахНеФильтрованные КАК Изменения
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ПараметрыДокументовПоследовательности КАК Последовательность
	|		ПО (НЕ Последовательность.ЭтоДокументОснование)
	|			И Изменения.Ссылка = Последовательность.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ ДокументДоКорректировки КАК ДокументДоКорректировки
	|		ПО (ИСТИНА),
	|	ИсправляемыйДокумент КАК ИсправляемыйДокумент";
	
	// Табличные части Товары (до корректировки, до исправления, после исправления)
	
	ТекстЗапроса = ТекстЗапроса + ОбщегоНазначения.РазделительПакетаЗапросов() +
	"ВЫБРАТЬ
	|	ТоварыИсходнойРеализации.Номенклатура КАК Номенклатура,
	|	ТоварыИсходнойРеализации.Характеристика КАК Характеристика,
	|	ТоварыИсходнойРеализации.Серия КАК Серия,
	|	ТоварыИсходнойРеализации.СтавкаНДС КАК СтавкаНДС,
	|	ТоварыИсходнойРеализации.НомерГТД КАК НомерГТД,
	|	ТоварыИсходнойРеализации.ТипЗапасов КАК ТипЗапасов,
	|	ТоварыИсходнойРеализации.Количество КАК Количество,
	|	ТоварыИсходнойРеализации.СуммаСНДС КАК СуммаСНДС,
	|	ТоварыИсходнойРеализации.СуммаНДС КАК СуммаНДС
	|ПОМЕСТИТЬ ТоварыДоКорректировкиРазвернутые
	|ИЗ
	|	ТоварыИсходнойРеализации КАК ТоварыИсходнойРеализации
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ИзмененияВТоварах.Номенклатура,
	|	ИзмененияВТоварах.Характеристика,
	|	ИзмененияВТоварах.Серия,
	|	ИзмененияВТоварах.СтавкаНДС,
	|	ИзмененияВТоварах.НомерГТД,
	|	ИзмененияВТоварах.ТипЗапасов,
	|	ИзмененияВТоварах.Количество,
	|	ИзмененияВТоварах.СуммаСНДС,
	|	ИзмененияВТоварах.СуммаНДС
	|ИЗ
	|	ИзмененияВТоварах КАК ИзмененияВТоварах
	|ГДЕ
	|	ИзмененияВТоварах.ИзмененияДоКорректировки
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТоварыДоКорректировкиРазвернутые.Номенклатура КАК Номенклатура,
	|	ТоварыДоКорректировкиРазвернутые.Характеристика КАК Характеристика,
	|	ТоварыДоКорректировкиРазвернутые.Серия КАК Серия,
	|	ТоварыДоКорректировкиРазвернутые.СтавкаНДС КАК СтавкаНДС,
	|	ТоварыДоКорректировкиРазвернутые.НомерГТД КАК НомерГТД,
	|	ТоварыДоКорректировкиРазвернутые.ТипЗапасов КАК ТипЗапасов,
	|	СУММА(ТоварыДоКорректировкиРазвернутые.Количество) КАК Количество,
	|	СУММА(ТоварыДоКорректировкиРазвернутые.СуммаСНДС) КАК СуммаСНДС,
	|	СУММА(ТоварыДоКорректировкиРазвернутые.СуммаНДС) КАК СуммаНДС
	|ПОМЕСТИТЬ ТоварыДоКорректировки
	|ИЗ
	|	ТоварыДоКорректировкиРазвернутые КАК ТоварыДоКорректировкиРазвернутые
	|
	|СГРУППИРОВАТЬ ПО
	|	ТоварыДоКорректировкиРазвернутые.Номенклатура,
	|	ТоварыДоКорректировкиРазвернутые.Характеристика,
	|	ТоварыДоКорректировкиРазвернутые.СтавкаНДС,
	|	ТоварыДоКорректировкиРазвернутые.НомерГТД,
	|	ТоварыДоКорректировкиРазвернутые.ТипЗапасов,
	|	ТоварыДоКорректировкиРазвернутые.Серия
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	Характеристика,
	|	СтавкаНДС,
	|	НомерГТД,
	|	ТипЗапасов
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТоварыИсходнойРеализации.Номенклатура КАК Номенклатура,
	|	ТоварыИсходнойРеализации.Характеристика КАК Характеристика,
	|	ТоварыИсходнойРеализации.Серия КАК Серия,
	|	ТоварыИсходнойРеализации.СтавкаНДС КАК СтавкаНДС,
	|	ТоварыИсходнойРеализации.НомерГТД КАК НомерГТД,
	|	ТоварыИсходнойРеализации.ТипЗапасов КАК ТипЗапасов,
	|	ТоварыИсходнойРеализации.Количество КАК Количество,
	|	ТоварыИсходнойРеализации.СуммаСНДС КАК СуммаСНДС,
	|	ТоварыИсходнойРеализации.СуммаНДС КАК СуммаНДС
	|ПОМЕСТИТЬ ТоварыДоИсправленияРазвернутые
	|ИЗ
	|	ТоварыИсходнойРеализации КАК ТоварыИсходнойРеализации
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ИзмененияВТоварах.Номенклатура,
	|	ИзмененияВТоварах.Характеристика,
	|	ИзмененияВТоварах.Серия,
	|	ИзмененияВТоварах.СтавкаНДС,
	|	ИзмененияВТоварах.НомерГТД,
	|	ИзмененияВТоварах.ТипЗапасов,
	|	ИзмененияВТоварах.Количество,
	|	ИзмененияВТоварах.СуммаСНДС,
	|	ИзмененияВТоварах.СуммаНДС
	|ИЗ
	|	ИзмененияВТоварах КАК ИзмененияВТоварах
	|ГДЕ
	|	ИзмененияВТоварах.ИзмененияДоИсправления
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТоварыДоИсправленияРазвернутые.Номенклатура КАК Номенклатура,
	|	ТоварыДоИсправленияРазвернутые.Характеристика КАК Характеристика,
	|	ТоварыДоИсправленияРазвернутые.Серия КАК Серия,
	|	ТоварыДоИсправленияРазвернутые.СтавкаНДС КАК СтавкаНДС,
	|	ТоварыДоИсправленияРазвернутые.НомерГТД КАК НомерГТД,
	|	ТоварыДоИсправленияРазвернутые.ТипЗапасов КАК ТипЗапасов,
	|	СУММА(ТоварыДоИсправленияРазвернутые.Количество) КАК Количество,
	|	СУММА(ТоварыДоИсправленияРазвернутые.СуммаСНДС) КАК СуммаСНДС,
	|	СУММА(ТоварыДоИсправленияРазвернутые.СуммаНДС) КАК СуммаНДС
	|ПОМЕСТИТЬ ТоварыДоИсправления
	|ИЗ
	|	ТоварыДоИсправленияРазвернутые КАК ТоварыДоИсправленияРазвернутые
	|
	|СГРУППИРОВАТЬ ПО
	|	ТоварыДоИсправленияРазвернутые.Номенклатура,
	|	ТоварыДоИсправленияРазвернутые.Характеристика,
	|	ТоварыДоИсправленияРазвернутые.СтавкаНДС,
	|	ТоварыДоИсправленияРазвернутые.НомерГТД,
	|	ТоварыДоИсправленияРазвернутые.ТипЗапасов,
	|	ТоварыДоИсправленияРазвернутые.Серия
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	Характеристика,
	|	СтавкаНДС,
	|	НомерГТД,
	|	ТипЗапасов
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТоварыИсходнойРеализации.Номенклатура КАК Номенклатура,
	|	ТоварыИсходнойРеализации.Характеристика КАК Характеристика,
	|	ТоварыИсходнойРеализации.Серия КАК Серия,
	|	ТоварыИсходнойРеализации.СтавкаНДС КАК СтавкаНДС,
	|	ТоварыИсходнойРеализации.НомерГТД КАК НомерГТД,
	|	ТоварыИсходнойРеализации.ТипЗапасов КАК ТипЗапасов,
	|	ТоварыИсходнойРеализации.Количество КАК Количество,
	|	ТоварыИсходнойРеализации.СуммаСНДС КАК СуммаСНДС,
	|	ТоварыИсходнойРеализации.СуммаНДС КАК СуммаНДС
	|ПОМЕСТИТЬ ТоварыКонечныеРазвернутые
	|ИЗ
	|	ТоварыИсходнойРеализации КАК ТоварыИсходнойРеализации
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ИзмененияВТоварах.Номенклатура,
	|	ИзмененияВТоварах.Характеристика,
	|	ИзмененияВТоварах.Серия,
	|	ИзмененияВТоварах.СтавкаНДС,
	|	ИзмененияВТоварах.НомерГТД,
	|	ИзмененияВТоварах.ТипЗапасов,
	|	ИзмененияВТоварах.Количество,
	|	ИзмененияВТоварах.СуммаСНДС,
	|	ИзмененияВТоварах.СуммаНДС
	|ИЗ
	|	ИзмененияВТоварах КАК ИзмененияВТоварах
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ТоварыКонечныеРазвернутые.Номенклатура КАК Номенклатура,
	|	ТоварыКонечныеРазвернутые.Характеристика КАК Характеристика,
	|	ТоварыКонечныеРазвернутые.Серия КАК Серия,
	|	ТоварыКонечныеРазвернутые.СтавкаНДС КАК СтавкаНДС,
	|	ТоварыКонечныеРазвернутые.НомерГТД КАК НомерГТД,
	|	ТоварыКонечныеРазвернутые.ТипЗапасов КАК ТипЗапасов,
	|	СУММА(ТоварыКонечныеРазвернутые.Количество) КАК Количество,
	|	СУММА(ТоварыКонечныеРазвернутые.СуммаСНДС) КАК СуммаСНДС,
	|	СУММА(ТоварыКонечныеРазвернутые.СуммаНДС) КАК СуммаНДС
	|ПОМЕСТИТЬ ТоварыКонечные
	|ИЗ
	|	ТоварыКонечныеРазвернутые КАК ТоварыКонечныеРазвернутые
	|
	|СГРУППИРОВАТЬ ПО
	|	ТоварыКонечныеРазвернутые.Номенклатура,
	|	ТоварыКонечныеРазвернутые.Характеристика,
	|	ТоварыКонечныеРазвернутые.СтавкаНДС,
	|	ТоварыКонечныеРазвернутые.НомерГТД,
	|	ТоварыКонечныеРазвернутые.ТипЗапасов,
	|	ТоварыКонечныеРазвернутые.Серия
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Номенклатура,
	|	Характеристика,
	|	СтавкаНДС,
	|	НомерГТД,
	|	ТипЗапасов";
	
	// Результирующая табличная часть Товары
	ТекстЗапроса = ТекстЗапроса + ОбщегоНазначения.РазделительПакетаЗапросов() +
	"ВЫБРАТЬ
	|	Товары.Номенклатура КАК Номенклатура,
	|	Товары.Характеристика КАК Характеристика,
	|	Товары.Серия КАК Серия,
	|	"""" КАК Содержание,
	|	Товары.НомерСтроки КАК НомерСтроки
	|ПОМЕСТИТЬ НомераСтрокРазвернутые
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.Товары КАК Товары
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ИсправляемыйДокумент КАК ИсправляемыйДокумент
	|		ПО Товары.Ссылка = ИсправляемыйДокумент.Ссылка
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЗНАЧЕНИЕ(Справочник.Номенклатура.ПустаяСсылка),
	|	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка),
	|	ЗНАЧЕНИЕ(Справочник.СерииНоменклатуры.ПустаяСсылка),
	|	Услуги.Содержание,
	|	Услуги.НомерСтроки
	|ИЗ
	|	Документ.АктВыполненныхРабот.Услуги КАК Услуги
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ИсправляемыйДокумент КАК ИсправляемыйДокумент
	|		ПО Услуги.Ссылка = ИсправляемыйДокумент.Ссылка
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Товары.Номенклатура,
	|	Товары.Характеристика,
	|	Товары.Серия,
	|	Товары.Содержание,
	|	Товары.НомерСтроки
	|ИЗ
	|	Документ.КорректировкаРеализации.Товары КАК Товары
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ИсправляемыйДокумент КАК ИсправляемыйДокумент
	|		ПО Товары.Ссылка = ИсправляемыйДокумент.Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	НомераСтрокРазвернутые.Номенклатура КАК Номенклатура,
	|	НомераСтрокРазвернутые.Содержание КАК Содержание,
	|	МАКСИМУМ(НомераСтрокРазвернутые.НомерСтроки) КАК НомерСтроки
	|ПОМЕСТИТЬ НомераСтрок
	|ИЗ
	|	НомераСтрокРазвернутые КАК НомераСтрокРазвернутые
	|
	|СГРУППИРОВАТЬ ПО
	|	НомераСтрокРазвернутые.Номенклатура,
	|	НомераСтрокРазвернутые.Содержание
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	НомераСтрокРазвернутые.Номенклатура,
	|	НомераСтрокРазвернутые.Содержание
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Т.Номенклатура КАК Номенклатура,
	|	Т.Характеристика КАК Характеристика,
	|	Т.Серия КАК Серия,
	|	Т.СтавкаНДС КАК СтавкаНДС,
	|	Т.НомерГТД КАК НомерГТД,
	|	Т.ТипЗапасов КАК ТипЗапасов,
	|	МАКСИМУМ(Т.ТоварыИсправляемогоДокумента_Количество) КАК ТоварыИсправляемогоДокумента_Количество,
	|	МАКСИМУМ(Т.ТоварыИсправляемогоДокумента_Сумма) КАК ТоварыИсправляемогоДокумента_Сумма,
	|	МАКСИМУМ(Т.ТоварыИсправляемогоДокумента_СуммаНДС) КАК ТоварыИсправляемогоДокумента_СуммаНДС,
	|	МАКСИМУМ(Т.ТоварыИсправляемогоДокумента_СуммаСНДС) КАК ТоварыИсправляемогоДокумента_СуммаСНДС,
	|	МАКСИМУМ(Т.ТоварыИсправительногоДокумента_Количество) КАК ТоварыИсправительногоДокумента_Количество,
	|	МАКСИМУМ(Т.ТоварыИсправительногоДокумента_Сумма) КАК ТоварыИсправительногоДокумента_Сумма,
	|	МАКСИМУМ(Т.ТоварыИсправительногоДокумента_СуммаНДС) КАК ТоварыИсправительногоДокумента_СуммаНДС,
	|	МАКСИМУМ(Т.ТоварыИсправительногоДокумента_СуммаСНДС) КАК ТоварыИсправительногоДокумента_СуммаСНДС,
	|	МАКСИМУМ(Т.ТоварыДокументаДоКорректировки_Количество) КАК ТоварыДокументаДоКорректировки_Количество,
	|	МАКСИМУМ(Т.ТоварыДокументаДоКорректировки_Сумма) КАК ТоварыДокументаДоКорректировки_Сумма,
	|	МАКСИМУМ(Т.ТоварыДокументаДоКорректировки_СуммаНДС) КАК ТоварыДокументаДоКорректировки_СуммаНДС,
	|	МАКСИМУМ(Т.ТоварыДокументаДоКорректировки_СуммаСНДС) КАК ТоварыДокументаДоКорректировки_СуммаСНДС
	|ПОМЕСТИТЬ РезультатСопоставленияТоваровВрем
	|ИЗ
	|	(ВЫБРАТЬ
	|		ТоварыИсправляемогоДокумента.Номенклатура КАК Номенклатура,
	|		ТоварыИсправляемогоДокумента.Характеристика КАК Характеристика,
	|		ТоварыИсправляемогоДокумента.Серия КАК Серия,
	|		ТоварыИсправляемогоДокумента.СтавкаНДС КАК СтавкаНДС,
	|		ТоварыИсправляемогоДокумента.НомерГТД КАК НомерГТД,
	|		ТоварыИсправляемогоДокумента.ТипЗапасов КАК ТипЗапасов,
	|		ТоварыИсправляемогоДокумента.Количество КАК ТоварыИсправляемогоДокумента_Количество,
	|		ВЫБОР
	|			КОГДА &ЦенаВключаетНДС
	|				ТОГДА ТоварыИсправляемогоДокумента.СуммаСНДС
	|			ИНАЧЕ ТоварыИсправляемогоДокумента.СуммаСНДС - ТоварыИсправляемогоДокумента.СуммаНДС
	|		КОНЕЦ КАК ТоварыИсправляемогоДокумента_Сумма,
	|		ТоварыИсправляемогоДокумента.СуммаНДС КАК ТоварыИсправляемогоДокумента_СуммаНДС,
	|		ТоварыИсправляемогоДокумента.СуммаСНДС КАК ТоварыИсправляемогоДокумента_СуммаСНДС,
	|		NULL КАК ТоварыИсправительногоДокумента_Количество,
	|		NULL КАК ТоварыИсправительногоДокумента_Сумма,
	|		NULL КАК ТоварыИсправительногоДокумента_СуммаСНДС,
	|		NULL КАК ТоварыИсправительногоДокумента_СуммаНДС,
	|		NULL КАК ТоварыДокументаДоКорректировки_Количество,
	|		NULL КАК ТоварыДокументаДоКорректировки_Сумма,
	|		NULL КАК ТоварыДокументаДоКорректировки_СуммаНДС,
	|		NULL КАК ТоварыДокументаДоКорректировки_СуммаСНДС
	|	ИЗ
	|		ТоварыДоИсправления КАК ТоварыИсправляемогоДокумента
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ТоварыИсправительногоДокумента.Номенклатура,
	|		ТоварыИсправительногоДокумента.Характеристика,
	|		ТоварыИсправительногоДокумента.Серия,
	|		ТоварыИсправительногоДокумента.СтавкаНДС,
	|		ТоварыИсправительногоДокумента.НомерГТД,
	|		ТоварыИсправительногоДокумента.ТипЗапасов,
	|		NULL,
	|		NULL,
	|		NULL,
	|		NULL,
	|		ТоварыИсправительногоДокумента.Количество,
	|		ВЫБОР
	|			КОГДА &ЦенаВключаетНДС
	|				ТОГДА ТоварыИсправительногоДокумента.СуммаСНДС
	|			ИНАЧЕ ТоварыИсправительногоДокумента.СуммаСНДС - ТоварыИсправительногоДокумента.СуммаНДС
	|		КОНЕЦ,
	|		ТоварыИсправительногоДокумента.СуммаСНДС,
	|		ТоварыИсправительногоДокумента.СуммаНДС,
	|		NULL,
	|		NULL,
	|		NULL,
	|		NULL
	|	ИЗ
	|		ТоварыКонечные КАК ТоварыИсправительногоДокумента
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ТоварыДокументаДоКорректировки.Номенклатура,
	|		ТоварыДокументаДоКорректировки.Характеристика,
	|		ТоварыДокументаДоКорректировки.Серия,
	|		ТоварыДокументаДоКорректировки.СтавкаНДС,
	|		ТоварыДокументаДоКорректировки.НомерГТД,
	|		ТоварыДокументаДоКорректировки.ТипЗапасов,
	|		NULL,
	|		NULL,
	|		NULL,
	|		NULL,
	|		NULL,
	|		NULL,
	|		NULL,
	|		NULL,
	|		ТоварыДокументаДоКорректировки.Количество,
	|		ВЫБОР
	|			КОГДА &ЦенаВключаетНДС
	|				ТОГДА ТоварыДокументаДоКорректировки.СуммаСНДС
	|			ИНАЧЕ ТоварыДокументаДоКорректировки.СуммаСНДС - ТоварыДокументаДоКорректировки.СуммаНДС
	|		КОНЕЦ,
	|		ТоварыДокументаДоКорректировки.СуммаНДС,
	|		ТоварыДокументаДоКорректировки.СуммаСНДС
	|	ИЗ
	|		ТоварыДоКорректировки КАК ТоварыДокументаДоКорректировки) КАК Т
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.Номенклатура,
	|	Т.Характеристика,
	|	Т.СтавкаНДС,
	|	Т.НомерГТД,
	|	Т.ТипЗапасов,
	|	Т.Серия
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	РезультатСопоставленияТоваровВрем.Номенклатура КАК Номенклатура,
	|	РезультатСопоставленияТоваровВрем.Характеристика КАК Характеристика,
	|	РезультатСопоставленияТоваровВрем.Серия КАК Серия,
	|	РезультатСопоставленияТоваровВрем.СтавкаНДС КАК СтавкаНДС,
	|	РезультатСопоставленияТоваровВрем.НомерГТД КАК НомерГТД,
	|	ВЫБОР
	|		КОГДА РезультатСопоставленияТоваровВрем.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.КомиссионныйТовар)
	|			ТОГДА ""ТоварыНаСкладе""
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК СчетУчета,
	|	РезультатСопоставленияТоваровВрем.ТоварыДокументаДоКорректировки_Количество КАК КоличествоДоКорректировки,
	|	РезультатСопоставленияТоваровВрем.ТоварыДокументаДоКорректировки_СуммаСНДС - ВЫБОР
	|		КОГДА &ЦенаВключаетНДС
	|			ТОГДА 0
	|		ИНАЧЕ РезультатСопоставленияТоваровВрем.ТоварыДокументаДоКорректировки_СуммаНДС
	|	КОНЕЦ КАК СуммаДоКорректировки,
	|	РезультатСопоставленияТоваровВрем.ТоварыДокументаДоКорректировки_СуммаНДС КАК СуммаНДСДоКорректировки,
	|	РезультатСопоставленияТоваровВрем.ТоварыИсправляемогоДокумента_Количество КАК КоличествоДоИзменения,
	|	РезультатСопоставленияТоваровВрем.ТоварыИсправляемогоДокумента_СуммаСНДС - ВЫБОР
	|		КОГДА &ЦенаВключаетНДС
	|			ТОГДА 0
	|		ИНАЧЕ РезультатСопоставленияТоваровВрем.ТоварыИсправляемогоДокумента_СуммаНДС
	|	КОНЕЦ КАК СуммаДоИзменения,
	|	РезультатСопоставленияТоваровВрем.ТоварыИсправляемогоДокумента_СуммаНДС КАК СуммаНДСДоИзменения,
	|	РезультатСопоставленияТоваровВрем.ТоварыИсправительногоДокумента_СуммаСНДС КАК СуммаСНДС,
	|	РезультатСопоставленияТоваровВрем.ТоварыИсправительногоДокумента_Количество КАК Количество,
	|	РезультатСопоставленияТоваровВрем.ТоварыИсправительногоДокумента_СуммаСНДС - ВЫБОР
	|		КОГДА &ЦенаВключаетНДС
	|			ТОГДА 0
	|		ИНАЧЕ РезультатСопоставленияТоваровВрем.ТоварыИсправительногоДокумента_СуммаНДС
	|	КОНЕЦ КАК Сумма,
	|	РезультатСопоставленияТоваровВрем.ТоварыИсправительногоДокумента_СуммаНДС КАК СуммаНДС,
	|	ВЫБОР
	|		КОГДА РезультатСопоставленияТоваровВрем.ТоварыИсправляемогоДокумента_СуммаСНДС ЕСТЬ NULL
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ЕстьВДокументеПоступленияРеализации
	|ПОМЕСТИТЬ РезультатСопоставленияТоваров
	|ИЗ
	|	РезультатСопоставленияТоваровВрем КАК РезультатСопоставленияТоваровВрем
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	РезультатСопоставления.Номенклатура КАК Номенклатура,
	|	&ТекстЗапросаХарактеристика,
	|	&ТекстЗапросаСерия,
	|	РезультатСопоставления.СтавкаНДС КАК СтавкаНДС,
	|	РезультатСопоставления.СтавкаНДС КАК СтавкаНДСДоИзменения,
	|	РезультатСопоставления.НомерГТД.Код КАК НомерГТД,
	|	РезультатСопоставления.НомерГТД.Код КАК НомерГТДДоИзменения,
	|	РезультатСопоставления.НомерГТД.СтранаПроисхождения КАК СтранаПроисхождения,
	|	РезультатСопоставления.НомерГТД.СтранаПроисхождения КАК СтранаПроисхожденияДоИзменения,
	|	РезультатСопоставления.КоличествоДоКорректировки КАК КоличествоДоКорректировки,
	|	РезультатСопоставления.КоличествоДоИзменения КАК КоличествоДоИзменения,
	|	РезультатСопоставления.Количество КАК Количество,
	|	РезультатСопоставления.СуммаДоКорректировки КАК СуммаДоКорректировки,
	|	РезультатСопоставления.СуммаДоИзменения КАК СуммаДоИзменения,
	|	РезультатСопоставления.Сумма КАК Сумма,
	|	РезультатСопоставления.СуммаНДСДоИзменения КАК СуммаНДСДоИзменения,
	|	РезультатСопоставления.СуммаНДС КАК СуммаНДС,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(РезультатСопоставления.КоличествоДоКорректировки, 0) = 0
	|			ТОГДА 0
	|		ИНАЧЕ ВЫБОР
	|				КОГДА РезультатСопоставления.СуммаДоКорректировки / РезультатСопоставления.КоличествоДоКорректировки < 0.01
	|					ТОГДА 0.01
	|				ИНАЧЕ ВЫРАЗИТЬ(РезультатСопоставления.СуммаДоКорректировки / РезультатСопоставления.КоличествоДоКорректировки КАК ЧИСЛО(15, 2))
	|			КОНЕЦ
	|	КОНЕЦ КАК ЦенаДоКорректировки,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(РезультатСопоставления.КоличествоДоИзменения, 0) = 0
	|			ТОГДА 0
	|		ИНАЧЕ ВЫБОР
	|				КОГДА РезультатСопоставления.СуммаДоИзменения / РезультатСопоставления.КоличествоДоИзменения < 0.01
	|					ТОГДА 0.01
	|				ИНАЧЕ ВЫРАЗИТЬ(РезультатСопоставления.СуммаДоИзменения / РезультатСопоставления.КоличествоДоИзменения КАК ЧИСЛО(15, 2))
	|			КОНЕЦ
	|	КОНЕЦ КАК ЦенаДоИзменения,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(РезультатСопоставления.Количество, 0) = 0
	|			ТОГДА 0
	|		ИНАЧЕ ВЫБОР
	|				КОГДА РезультатСопоставления.Сумма / РезультатСопоставления.Количество < 0.01
	|					ТОГДА 0.01
	|				ИНАЧЕ ВЫРАЗИТЬ(РезультатСопоставления.Сумма / РезультатСопоставления.Количество КАК ЧИСЛО(15, 2))
	|			КОНЕЦ
	|	КОНЕЦ КАК Цена,
	|	ЕстьNull(НомераСтрок.НомерСтроки, 0) КАК НомерСтрокиДокумента,
	|	РезультатСопоставления.ЕстьВДокументеПоступленияРеализации КАК ЕстьВДокументеПоступленияРеализации
	|ИЗ
	|	РезультатСопоставленияТоваров КАК РезультатСопоставления
	|		ЛЕВОЕ СОЕДИНЕНИЕ НомераСтрок КАК НомераСтрок
	|		ПО РезультатСопоставления.Номенклатура = НомераСтрок.Номенклатура
	|
	|УПОРЯДОЧИТЬ ПО
	|	РезультатСопоставления.ЕстьВДокументеПоступленияРеализации УБЫВ,
	|	ЕстьNull(НомераСтрок.НомерСтроки, 0)";
	
	// Табличные части Услуги (до корректировки, до исправления, после исправления)
	
	ТекстЗапроса = ТекстЗапроса + ОбщегоНазначения.РазделительПакетаЗапросов() +
	"ВЫБРАТЬ
	|	Товары.Номенклатура,
	|	"""" КАК Содержание,
	|	Товары.СтавкаНДС,
	|	Товары.Количество,
	|	Товары.Сумма,
	|	Товары.СуммаНДС
	|ПОМЕСТИТЬ УслугиДоКорректировкиРазвернутые
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.Товары КАК Товары
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументДоКорректировки КАК ДокументДоКорректировки
	|		ПО Товары.Ссылка = ДокументДоКорректировки.Ссылка
	|			И (Товары.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга)
	|				ИЛИ Товары.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа))
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Услуги.Номенклатура,
	|	Услуги.Содержание,
	|	Услуги.СтавкаНДС,
	|	Услуги.Количество,
	|	Услуги.Сумма,
	|	Услуги.СуммаНДС
	|ИЗ
	|	Документ.АктВыполненныхРабот.Услуги КАК Услуги
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументДоКорректировки КАК ДокументДоКорректировки
	|		ПО Услуги.Ссылка = ДокументДоКорректировки.Ссылка
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	&ПустаяНоменклатура,
	|	Услуги.Содержание,
	|	Услуги.СтавкаНДС,
	|	Услуги.Количество,
	|	Услуги.Сумма,
	|	Услуги.СуммаНДС
	|ИЗ
	|	Документ.РеализацияУслугПрочихАктивов.Доходы КАК Услуги
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументДоКорректировки КАК ДокументДоКорректировки
	|		ПО Услуги.Ссылка = ДокументДоКорректировки.Ссылка
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Товары.Номенклатура,
	|	Товары.Содержание,
	|	Товары.СтавкаНДС,
	|	Товары.Количество,
	|	Товары.Сумма,
	|	Товары.СуммаНДС
	|ИЗ
	|	Документ.КорректировкаРеализации.Товары КАК Товары
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ДокументДоКорректировки КАК ДокументДоКорректировки
	|		ПО Товары.Ссылка = ДокументДоКорректировки.Ссылка
	|			И (Товары.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга)
	|				ИЛИ Товары.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа)
	|				ИЛИ &РеализацияУслуг)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	УслугиДоКорректировкиРазвернутые.Номенклатура,
	|	УслугиДоКорректировкиРазвернутые.Содержание,
	|	УслугиДоКорректировкиРазвернутые.СтавкаНДС,
	|	СУММА(УслугиДоКорректировкиРазвернутые.Количество) КАК Количество,
	|	СУММА(УслугиДоКорректировкиРазвернутые.Сумма) КАК Сумма,
	|	СУММА(УслугиДоКорректировкиРазвернутые.СуммаНДС) КАК СуммаНДС
	|ПОМЕСТИТЬ УслугиДоКорректировки
	|ИЗ
	|	УслугиДоКорректировкиРазвернутые КАК УслугиДоКорректировкиРазвернутые
	|
	|СГРУППИРОВАТЬ ПО
	|	УслугиДоКорректировкиРазвернутые.Номенклатура,
	|	УслугиДоКорректировкиРазвернутые.Содержание,
	|	УслугиДоКорректировкиРазвернутые.СтавкаНДС
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Товары.Номенклатура,
	|	"""" КАК Содержание,
	|	Товары.СтавкаНДС,
	|	Товары.Количество,
	|	Товары.Сумма,
	|	Товары.СуммаСНДС,
	|	Товары.СуммаНДС
	|ПОМЕСТИТЬ УслугиДоИсправленияРазвернутые
	|ИЗ
	|	Документ.РеализацияТоваровУслуг.Товары КАК Товары
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ИсправляемыйДокумент КАК ИсправляемыйДокумент
	|		ПО Товары.Ссылка = ИсправляемыйДокумент.Ссылка
	|			И (Товары.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга)
	|				ИЛИ Товары.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа))
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Услуги.Номенклатура,
	|	Услуги.Содержание,
	|	Услуги.СтавкаНДС,
	|	Услуги.Количество,
	|	Услуги.Сумма,
	|	Услуги.СуммаСНДС,
	|	Услуги.СуммаНДС
	|ИЗ
	|	Документ.АктВыполненныхРабот.Услуги КАК Услуги
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ИсправляемыйДокумент КАК ИсправляемыйДокумент
	|		ПО Услуги.Ссылка = ИсправляемыйДокумент.Ссылка
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	&ПустаяНоменклатура,
	|	Услуги.Содержание,
	|	Услуги.СтавкаНДС,
	|	Услуги.Количество,
	|	Услуги.Сумма,
	|	Услуги.СуммаСНДС,
	|	Услуги.СуммаНДС
	|ИЗ
	|	Документ.РеализацияУслугПрочихАктивов.Доходы КАК Услуги
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ИсправляемыйДокумент КАК ИсправляемыйДокумент
	|		ПО Услуги.Ссылка = ИсправляемыйДокумент.Ссылка
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Товары.Номенклатура,
	|	Товары.Содержание,
	|	Товары.СтавкаНДС,
	|	Товары.Количество,
	|	Товары.Сумма,
	|	Товары.СуммаСНДС,
	|	Товары.СуммаНДС
	|ИЗ
	|	Документ.КорректировкаРеализации.Товары КАК Товары
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ИсправляемыйДокумент КАК ИсправляемыйДокумент
	|		ПО Товары.Ссылка = ИсправляемыйДокумент.Ссылка
	|			И (Товары.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга)
	|				ИЛИ Товары.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа)
	|				ИЛИ &РеализацияУслуг)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	УслугиДоИсправленияРазвернутые.Номенклатура,
	|	УслугиДоИсправленияРазвернутые.Содержание,
	|	УслугиДоИсправленияРазвернутые.СтавкаНДС,
	|	СУММА(УслугиДоИсправленияРазвернутые.Количество) КАК Количество,
	|	СУММА(УслугиДоИсправленияРазвернутые.Сумма) КАК Сумма,
	|	СУММА(УслугиДоИсправленияРазвернутые.СуммаСНДС) КАК СуммаСНДС,
	|	СУММА(УслугиДоИсправленияРазвернутые.СуммаНДС) КАК СуммаНДС
	|ПОМЕСТИТЬ УслугиДоИсправления
	|ИЗ
	|	УслугиДоИсправленияРазвернутые КАК УслугиДоИсправленияРазвернутые
	|
	|СГРУППИРОВАТЬ ПО
	|	УслугиДоИсправленияРазвернутые.Номенклатура,
	|	УслугиДоИсправленияРазвернутые.Содержание,
	|	УслугиДоИсправленияРазвернутые.СтавкаНДС
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Товары.Номенклатура,
	|	Товары.Содержание,
	|	Товары.СтавкаНДС,
	|	СУММА(Товары.Количество) КАК Количество,
	|	СУММА(Товары.Сумма) КАК Сумма,
	|	СУММА(Товары.СуммаНДС) КАК СуммаНДС,
	|	СУММА(Товары.СуммаСНДС) КАК СуммаСНДС
	|ПОМЕСТИТЬ УслугиКонечные
	|ИЗ
	|	Документ.КорректировкаРеализации.Товары КАК Товары
	|ГДЕ
	|	Товары.Ссылка = &Ссылка
	|	И (Товары.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Услуга)
	|		ИЛИ Товары.Номенклатура.ТипНоменклатуры = ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Работа)
	|		ИЛИ &РеализацияУслуг)
	|
	|СГРУППИРОВАТЬ ПО
	|	Товары.Номенклатура,
	|	Товары.Содержание,
	|	Товары.СтавкаНДС";
		
	// Результирующая табличная часть Услуги
	ТекстЗапроса = ТекстЗапроса + ОбщегоНазначения.РазделительПакетаЗапросов() +
	"ВЫБРАТЬ
	|	Т.Номенклатура,
	|	Т.Содержание,
	|	Т.СтавкаНДС,
	|	МАКСИМУМ(Т.УслугиИсправляемогоДокумента_Количество) КАК УслугиИсправляемогоДокумента_Количество,
	|	МАКСИМУМ(Т.УслугиИсправляемогоДокумента_Сумма) КАК УслугиИсправляемогоДокумента_Сумма,
	|	МАКСИМУМ(Т.УслугиИсправляемогоДокумента_СуммаНДС) КАК УслугиИсправляемогоДокумента_СуммаНДС,
	|	МАКСИМУМ(Т.УслугиИсправительногоДокумента_Количество) КАК УслугиИсправительногоДокумента_Количество,
	|	МАКСИМУМ(Т.УслугиИсправительногоДокумента_Сумма) КАК УслугиИсправительногоДокумента_Сумма,
	|	МАКСИМУМ(Т.УслугиИсправительногоДокумента_СуммаНДС) КАК УслугиИсправительногоДокумента_СуммаНДС,
	|	МАКСИМУМ(Т.УслугиИсправительногоДокумента_СуммаСНДС) КАК УслугиИсправительногоДокумента_СуммаСНДС,
	|	МАКСИМУМ(Т.УслугиДокументаДоКорректировки_Количество) КАК УслугиДокументаДоКорректировки_Количество,
	|	МАКСИМУМ(Т.УслугиДокументаДоКорректировки_Сумма) КАК УслугиДокументаДоКорректировки_Сумма,
	|	МАКСИМУМ(Т.УслугиДокументаДоКорректировки_СуммаНДС) КАК УслугиДокументаДоКорректировки_СуммаНДС
	|ПОМЕСТИТЬ РезультатСопоставленияУслугВрем
	|ИЗ
	|	(ВЫБРАТЬ
	|		УслугиИсправляемогоДокумента.Номенклатура КАК Номенклатура,
	|		УслугиИсправляемогоДокумента.Содержание КАК Содержание,
	|		УслугиИсправляемогоДокумента.СтавкаНДС КАК СтавкаНДС,
	|		NULL КАК УслугиИсправляемогоДокумента_Количество,
	|		NULL КАК УслугиИсправляемогоДокумента_Сумма,
	|		NULL КАК УслугиИсправляемогоДокумента_СуммаНДС,
	|		УслугиИсправляемогоДокумента.Количество КАК УслугиИсправительногоДокумента_Количество,
	|		УслугиИсправляемогоДокумента.Сумма КАК УслугиИсправительногоДокумента_Сумма,
	|		УслугиИсправляемогоДокумента.СуммаСНДС КАК УслугиИсправительногоДокумента_СуммаСНДС,
	|		УслугиИсправляемогоДокумента.СуммаНДС КАК УслугиИсправительногоДокумента_СуммаНДС,
	|		NULL КАК УслугиДокументаДоКорректировки_Количество,
	|		NULL КАК УслугиДокументаДоКорректировки_Сумма,
	|		NULL КАК УслугиДокументаДоКорректировки_СуммаНДС
	|	ИЗ
	|		УслугиКонечные КАК УслугиИсправляемогоДокумента
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		УслугиИсправительногоДокумента.Номенклатура,
	|		УслугиИсправительногоДокумента.Содержание,
	|		УслугиИсправительногоДокумента.СтавкаНДС,
	|		УслугиИсправительногоДокумента.Количество,
	|		УслугиИсправительногоДокумента.Сумма,
	|		УслугиИсправительногоДокумента.СуммаНДС,
	|		NULL,
	|		NULL,
	|		NULL,
	|		NULL,
	|		NULL,
	|		NULL,
	|		NULL
	|	ИЗ
	|		УслугиДоИсправления КАК УслугиИсправительногоДокумента
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		УслугиДокументаДоКорректировки.Номенклатура,
	|		УслугиДокументаДоКорректировки.Содержание,
	|		УслугиДокументаДоКорректировки.СтавкаНДС,
	|		NULL,
	|		NULL,
	|		NULL,
	|		NULL,
	|		NULL,
	|		NULL,
	|		NULL,
	|		УслугиДокументаДоКорректировки.Количество,
	|		УслугиДокументаДоКорректировки.Сумма,
	|		УслугиДокументаДоКорректировки.СуммаНДС
	|	ИЗ
	|		УслугиДоКорректировки КАК УслугиДокументаДоКорректировки) КАК Т
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.Номенклатура,
	|	Т.Содержание,
	|	Т.СтавкаНДС
	|;
	|
	|ВЫБРАТЬ
	|	Номенклатура,
	|	Содержание,
	|	СтавкаНДС,
	|	УслугиДокументаДоКорректировки_Количество КАК КоличествоДоКорректировки,
	|	УслугиДокументаДоКорректировки_Сумма КАК СуммаДоКорректировки,
	|	УслугиДокументаДоКорректировки_СуммаНДС КАК СуммаНДСДоКорректировки,
	|	УслугиИсправляемогоДокумента_Количество КАК КоличествоДоИзменения,
	|	УслугиИсправляемогоДокумента_Сумма КАК СуммаДоИзменения,
	|	УслугиИсправляемогоДокумента_СуммаНДС КАК СуммаНДСДоИзменения,
	|	УслугиИсправительногоДокумента_СуммаСНДС КАК СуммаСНДС,
	|	УслугиИсправительногоДокумента_Количество КАК Количество,
	|	УслугиИсправительногоДокумента_Сумма КАК Сумма,
	|	УслугиИсправительногоДокумента_СуммаНДС КАК СуммаНДС,
	|	ВЫБОР
	|		КОГДА УслугиИсправляемогоДокумента_Сумма ЕСТЬ NULL 
	|			ТОГДА ЛОЖЬ
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ КАК ЕстьВДокументеРеализации
	|ПОМЕСТИТЬ РезультатСопоставленияУслуг
	|ИЗ
	|	РезультатСопоставленияУслугВрем КАК РезультатСопоставленияУслугВрем
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	РезультатСопоставления.Номенклатура,
	|	РезультатСопоставления.Содержание,
	|	РезультатСопоставления.Содержание КАК СодержаниеДоИзменения,
	|	РезультатСопоставления.СтавкаНДС,
	|	РезультатСопоставления.СтавкаНДС КАК СтавкаНДСДоИзменения,
	|	РезультатСопоставления.КоличествоДоКорректировки,
	|	РезультатСопоставления.КоличествоДоИзменения,
	|	РезультатСопоставления.Количество,
	|	РезультатСопоставления.СуммаДоКорректировки,
	|	РезультатСопоставления.СуммаДоИзменения,
	|	РезультатСопоставления.Сумма КАК Сумма,
	|	РезультатСопоставления.СуммаНДСДоКорректировки,
	|	РезультатСопоставления.СуммаНДСДоИзменения,
	|	РезультатСопоставления.СуммаНДС КАК СуммаНДС,
	|	РезультатСопоставления.Номенклатура.Принципал 	КАК ПринципалСсылка,
	|	ВЫБОР КОГДА 
	|		РезультатСопоставления.Номенклатура.ОсобенностьУчета = ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.ОрганизациейПоАгентскойСхеме)
	|		ИЛИ РезультатСопоставления.Номенклатура.ОсобенностьУчета = ЗНАЧЕНИЕ(Перечисление.ОсобенностиУчетаНоменклатуры.Партнером) ТОГДА
	|			""Агентские""
	|		ИНАЧЕ ""Собственные""
	|	КОНЕЦ КАК ТипУслуги,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(РезультатСопоставления.КоличествоДоКорректировки, 0) = 0
	|			ТОГДА 0
	|		ИНАЧЕ ВЫРАЗИТЬ(РезультатСопоставления.СуммаДоКорректировки / РезультатСопоставления.КоличествоДоКорректировки КАК ЧИСЛО(15, 2))
	|	КОНЕЦ КАК ЦенаДоКорректировки,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(РезультатСопоставления.КоличествоДоИзменения, 0) = 0
	|			ТОГДА 0
	|		ИНАЧЕ ВЫРАЗИТЬ(РезультатСопоставления.СуммаДоИзменения / РезультатСопоставления.КоличествоДоИзменения КАК ЧИСЛО(15, 2))
	|	КОНЕЦ КАК ЦенаДоИзменения,
	|	ВЫБОР
	|		КОГДА ЕСТЬNULL(РезультатСопоставления.Количество, 0) = 0
	|			ТОГДА 0
	|		ИНАЧЕ ВЫРАЗИТЬ(РезультатСопоставления.Сумма / РезультатСопоставления.Количество КАК ЧИСЛО(15, 2))
	|	КОНЕЦ КАК Цена,
	|	ЕстьNull(НомераСтрок.НомерСтроки, 0) КАК НомерСтрокиДокумента,
	|	РезультатСопоставления.ЕстьВДокументеРеализации
	|ИЗ
	|	РезультатСопоставленияУслуг КАК РезультатСопоставления
	|		ЛЕВОЕ СОЕДИНЕНИЕ НомераСтрок КАК НомераСтрок
	|		ПО РезультатСопоставления.Номенклатура = НомераСтрок.Номенклатура
	|			И РезультатСопоставления.Содержание = НомераСтрок.Содержание
	|
	|УПОРЯДОЧИТЬ ПО
	|	РезультатСопоставления.ЕстьВДокументеРеализации УБЫВ,
	|	ЕстьNull(НомераСтрок.НомерСтроки, 0)";
	
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ТекстЗапросаХарактеристика",
		ПолучитьТекстЗапросаХарактеристики(КомпонентыОбмена, "РезультатСопоставления"));
		
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&ТекстЗапросаСерия",
		ПолучитьТекстЗапросаСерии(КомпонентыОбмена, "РезультатСопоставления"));
	
	Запрос = Новый Запрос(ТекстЗапроса);
	Запрос.УстановитьПараметр("ДокументОснование", ДанныеИБ.ДокументОснование);
	Запрос.УстановитьПараметр("МоментВремени", ДанныеИБ.МоментВремени());
	Запрос.УстановитьПараметр("РеализацияУслуг", 
		ТипЗнч(ДанныеИБ.ДокументОснование) = Тип("ДокументСсылка.АктВыполненныхРабот")
		ИЛИ ТипЗнч(ДанныеИБ.ДокументОснование) = Тип("ДокументСсылка.РеализацияУслугПрочихАктивов"));
	Запрос.УстановитьПараметр("ПустаяНоменклатура", Справочники.Номенклатура.ПустаяСсылка());
	Запрос.УстановитьПараметр("Ссылка", ДанныеИБ.Ссылка);
	Запрос.УстановитьПараметр("ЦенаВключаетНДС", ДанныеИБ.ЦенаВключаетНДС);
	
	РезультатыЗапроса = Запрос.ВыполнитьПакет();
	
	ВыборкаДанных = РезультатыЗапроса[6].Выбрать();
	Если ВыборкаДанных.Следующий() Тогда
		Если ЗначениеЗаполнено(ВыборкаДанных.Ссылка) Тогда
			СтруктураКлючевыеСвойства = Новый Структура("Дата, Номер, Ссылка, Организация");
			ТипСсылки = ТипЗнч(ВыборкаДанных.Ссылка);
			ИмяПКО = "";
			Если ТипСсылки = Тип("ДокументСсылка.СчетФактураВыданный") Тогда
				ИмяПКО = "Документ_СчетФактураВыданный_Отправка";
			ИначеЕсли ТипСсылки = Тип("ДокументСсылка.ВозвратТоваровОтКлиента") Тогда
				ИмяПКО = "Документ_ВозвратТоваровОтКлиента_Отправка";
			ИначеЕсли ТипСсылки = Тип("ДокументСсылка.ВозвратТоваровПоставщику") Тогда
				ИмяПКО = "Документ_ВозвратТоваровПоставщику_Отправка";
			ИначеЕсли ТипСсылки = Тип("ДокументСсылка.РеализацияТоваровУслуг") Тогда
				ИмяПКО = "Документ_РеализацияТоваровУслуг_Отправка";
			ИначеЕсли ТипСсылки = Тип("ДокументСсылка.ОтчетКомиссионера") Тогда
				ИмяПКО = "Документ_ОтчетКомиссионера_Отправка";
			ИначеЕсли ТипСсылки = Тип("ДокументСсылка.ОтчетКомитенту") Тогда
				ИмяПКО = "Документ_ОтчетКомитенту_Отправка";
			ИначеЕсли ТипСсылки = Тип("ДокументСсылка.КорректировкаРеализации") Тогда
				ИмяПКО = "Документ_КорректировкаРеализации_Отправка";
			ИначеЕсли ТипСсылки = Тип("ДокументСсылка.АктВыполненныхРабот") Тогда
				ИмяПКО = "Документ_АктВыполненныхРабот_Отправка";
			ИначеЕсли ТипСсылки = Тип("ДокументСсылка.РеализацияУслугПрочихАктивов") Тогда
				ИмяПКО = "Документ_РеализацияУслугПрочихАктивов_Отправка";
			КонецЕсли;
			
			Если ИмяПКО = "Документ_АктВыполненныхРабот_Отправка"
				И Не СвойствоФорматаОбмена(КомпонентыОбмена, "Документ.АктВыполненныхРабот") Тогда
				ИмяПКО = "Документ_АктВыполненныхРаботРТУ_Отправка";
			КонецЕсли;
			
			Если ИмяПКО <> "" Тогда
				ЗаполнитьЗначенияСвойств(СтруктураКлючевыеСвойства, ВыборкаДанных);
				ДанныеXDTO.Вставить("ДокументРеализации", Новый Структура("Значение, ИмяПКО", СтруктураКлючевыеСвойства, ИмяПКО));
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	ДанныеXDTO.Вставить("ВидОперации");
	ДанныеXDTO.ВидОперации = ?(ДанныеИБ.ВидКорректировки = Перечисления.ХозяйственныеОперации.ИсправлениеОшибок,
		"ИсправлениеОшибки", "СогласованноеИзменение");
	
	ВыборкаДанных = РезультатыЗапроса[8].Выбрать();
	Если ВыборкаДанных.Следующий() Тогда
		Если ЗначениеЗаполнено(ВыборкаДанных.Ссылка) Тогда
			СтруктураКлючевыеСвойства = Новый Структура("Дата, Номер, Ссылка, Организация");
			ТипСсылки = ТипЗнч(ВыборкаДанных.Ссылка);
			ИмяПКО = "";
			Если ТипСсылки = Тип("ДокументСсылка.СчетФактураВыданный") Тогда
				ИмяПКО = "Документ_СчетФактураВыданный_Отправка";
			ИначеЕсли ТипСсылки = Тип("ДокументСсылка.ВозвратТоваровОтКлиента") Тогда
				ИмяПКО = "Документ_ВозвратТоваровОтКлиента_Отправка";
			ИначеЕсли ТипСсылки = Тип("ДокументСсылка.ВозвратТоваровПоставщику") Тогда
				ИмяПКО = "Документ_ВозвратТоваровПоставщику_Отправка";
			ИначеЕсли ТипСсылки = Тип("ДокументСсылка.РеализацияТоваровУслуг") Тогда
				ИмяПКО = "Документ_РеализацияТоваровУслуг_Отправка";
			ИначеЕсли ТипСсылки = Тип("ДокументСсылка.ОтчетКомиссионера") Тогда
				ИмяПКО = "Документ_ОтчетКомиссионера_Отправка";
			ИначеЕсли ТипСсылки = Тип("ДокументСсылка.ОтчетКомитенту") Тогда
				ИмяПКО = "Документ_ОтчетКомитенту_Отправка";
			ИначеЕсли ТипСсылки = Тип("ДокументСсылка.КорректировкаРеализации") Тогда
				ИмяПКО = "Документ_КорректировкаРеализации_Отправка";
			ИначеЕсли ТипСсылки = Тип("ДокументСсылка.АктВыполненныхРабот") Тогда
				ИмяПКО = "Документ_АктВыполненныхРабот_Отправка";
			ИначеЕсли ТипСсылки = Тип("ДокументСсылка.РеализацияУслугПрочихАктивов") Тогда
				ИмяПКО = "Документ_РеализацияУслугПрочихАктивов_Отправка";
			КонецЕсли;
			
			Если ИмяПКО = "Документ_АктВыполненныхРабот_Отправка"
				И Не СвойствоФорматаОбмена(КомпонентыОбмена, "Документ.АктВыполненныхРабот") Тогда
				ИмяПКО = "Документ_АктВыполненныхРаботРТУ_Отправка";
			КонецЕсли;
			
			Если ИмяПКО <> "" Тогда
				ЗаполнитьЗначенияСвойств(СтруктураКлючевыеСвойства, ВыборкаДанных);
				ДанныеXDTO.Вставить("ИсправляемыйДокументРеализации", Новый Структура("Значение, ИмяПКО", СтруктураКлючевыеСвойства, ИмяПКО));
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	НомерПоследнего = РезультатыЗапроса.Количество() - 1;
	ТаблицаТовары = РезультатыЗапроса[23].Выгрузить();
	ТаблицаУслуги = РезультатыЗапроса[НомерПоследнего].Выгрузить();
	
	ЗаполнитьХарактеристикуУпаковкуВТЧ(КомпонентыОбмена, ТаблицаТовары, Истина, Ложь);
	
	ВыгрузитьПодразделениеИзРеквизитаДокумента(КомпонентыОбмена, ДанныеИБ, ДанныеXDTO, "Склад");
	
	// Сумма документа.
	СуммаДокумента = 0;
	СуммаДокумента = СуммаДокумента + ТаблицаТовары.Итог("Сумма");
	СуммаДокумента = СуммаДокумента + ТаблицаУслуги.Итог("Сумма");
	Если НЕ ДанныеИБ.ЦенаВключаетНДС Тогда
		СуммаДокумента = СуммаДокумента + ТаблицаТовары.Итог("СуммаНДС");
		СуммаДокумента = СуммаДокумента + ТаблицаУслуги.Итог("СуммаНДС");
	КонецЕсли;
	Если СуммаДокумента = 0 Тогда
		СуммаДокумента = -1;
	КонецЕсли;
	ДанныеXDTO.Вставить("Сумма", СуммаДокумента);
	
	ТаблицаУслугЗаполнитьПринципала(КомпонентыОбмена, ТаблицаУслуги);
	
	ДанныеXDTO.Вставить("Товары", ТаблицаТовары);
	ДанныеXDTO.Вставить("Услуги", ТаблицаУслуги);
	
	// Дополнительные свойства для договора
	Если ЗначениеЗаполнено(ДанныеИБ.Договор) Тогда
		ДанныеXDTO.Вставить("Договор", ДанныеИБ.Договор);
	Иначе
		ПараметрыПоУмолчанию = Новый Структура(ДоговорФиксированнаяСтруктураКлючей());
		ПараметрыПоУмолчанию.Контрагент = ДанныеИБ.Контрагент;
		ПараметрыПоУмолчанию.Организация = ДанныеИБ.Организация;
		ПараметрыПоУмолчанию.ВалютаВзаиморасчетов = ДанныеИБ.ВалютаВзаиморасчетов;
		ПараметрыПоУмолчанию.ВидДоговора = "СПокупателем";
		ПараметрыПоУмолчанию.Дата = ДанныеИБ.Дата;
		ПараметрыПоУмолчанию.Номер = ДанныеИБ.Номер;
		Если ЗначениеЗаполнено(ДанныеИБ.Соглашение) Тогда
			РасчетыВУсловныхЕдиницах = ВзаиморасчетыСервер.РасчетыВУсловныхЕдиницах(ДанныеИБ.Соглашение);
		Иначе
			РасчетыВУсловныхЕдиницах = (ДанныеИБ.Валюта = Константы.ВалютаРегламентированногоУчета.Получить() И ДанныеИБ.Валюта <> ДанныеИБ.ВалютаВзаиморасчетов);
		КонецЕсли;
		ПараметрыПоУмолчанию.РасчетыВУсловныхЕдиницах = РасчетыВУсловныхЕдиницах;
		
		Выборка = РезультатыЗапроса[1].Выбрать();
		ЗаказКлиента = ?(Выборка.Следующий(), Выборка.Ссылка, Неопределено);
		Заказ = Новый Структура("Заказ, Соглашение, Сделка", ЗаказКлиента, ДанныеИБ.Соглашение, ДанныеИБ.Сделка);
		Договор = ДоговорИнструкцияКонвертацииПоДаннымВзаиморасчетов(ПараметрыПоУмолчанию, КомпонентыОбмена, Заказ, ДанныеИБ);
		ДанныеXDTO.Вставить("Договор", Договор);
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ДанныеИБ.БанковскийСчетОрганизации)
		И ДанныеИБ.БанковскийСчетОрганизации.Владелец <> ДанныеИБ.Организация Тогда
		ДанныеXDTO.Вставить("БанковскийСчетОрганизации", Неопределено);
	КонецЕсли;
	СкладДляВыгрузки = СкладДляВыгрузки(ДанныеИБ.Склад, КомпонентыОбмена.ПараметрыКонвертации, Истина);
	ДанныеXDTO.Вставить("Склад", СкладДляВыгрузки);
КонецПроцедуры
