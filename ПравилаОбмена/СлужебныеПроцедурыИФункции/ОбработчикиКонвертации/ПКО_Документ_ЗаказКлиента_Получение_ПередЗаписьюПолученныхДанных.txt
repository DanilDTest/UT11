Процедура ПКО_Документ_ЗаказКлиента_Получение_ПередЗаписьюПолученныхДанных(ПолученныеДанные, ДанныеИБ, КонвертацияСвойств, КомпонентыОбмена)
	ДанныеОбъект = ПолученныеДанные;
	Если ДанныеИБ <> Неопределено Тогда   
	
		ДанныеИБ.Проведен = ПолученныеДанные.Проведен;                                  
	
	
		СвойствоДатаРезерва = ПланыВидовХарактеристик.ДополнительныеРеквизитыИСведения.НайтиПоРеквизиту("Имя", "РезервДоВключительно");
		СтрокаСвойстваОбъекта = ДанныеИБ.ДополнительныеРеквизиты.Найти(СвойствоДатаРезерва, "Свойство");
	
		Если СтрокаСвойстваОбъекта =  Неопределено Тогда 
			СтрокаСвойстваОбъекта = ДанныеИБ.ДополнительныеРеквизиты.Добавить();
			СтрокаСвойстваОбъекта.Свойство = СвойствоДатаРезерва;
		КонецЕсли;
	
		СтрокаСвойстваОбъекта.Значение = ПолученныеДанные.ДополнительныеСвойства.ДатаРезерва;
		ДанныеИБ.Товары.Загрузить(ПолученныеДанные.Товары.Выгрузить());	
	                            
		        
		ОсновнаяПричинаОтмены = "";	                            
		Если ПолученныеДанные.ДополнительныеСвойства.Свойство("ОсновнаяПричинаОтмены") Тогда
			ОсновнаяПричинаОтмены = ПолученныеДанные.ДополнительныеСвойства.ОсновнаяПричинаОтмены;
		КонецЕсли;   
		
		ПолученныеДанные = Неопределено;
		
		ДанныеОбъект = ДанныеИБ;
	КонецЕсли;
	
	Для каждого СтрокаТовара из ДанныеОбъект.Товары Цикл
		СтрокаТовара.Склад = ДанныеОбъект.Склад;
		СтрокаТовара.ДатаОтгрузки = ДанныеОбъект.ЖелаемаяДатаОтгрузки;
	КонецЦикла;
	                                      
	        
	    СтруктураПересчетаСуммы = ОбработкаТабличнойЧастиКлиентСервер.ПараметрыПересчетаСуммыНДСВСтрокеТЧ(ДанныеОбъект);
	
	   	СтруктураДействий = Новый Структура;
	 	СтруктураДействий.Вставить("ПересчитатьСуммуНДС", СтруктураПересчетаСуммы);
		СтруктураДействий.Вставить("ПересчитатьСуммуСНДС", СтруктураПересчетаСуммы);
		СтруктураДействий.Вставить("ПересчитатьСумму");
		СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомРучнойСкидки", Новый Структура("Очищать", Ложь));
		СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомАвтоматическойСкидки", Новый Структура("Очищать", Истина));
		           
	  	ОбработкаТабличнойЧастиСервер.ОбработатьТЧ(ДанныеОбъект.Товары, СтруктураДействий, Неопределено);
	           
	                                     
	            
	Если НЕ ПустаяСтрока(ОсновнаяПричинаОтмены) Тогда  
		
		СвойствоПричинаОтмены = ПланыВидовХарактеристик.ДополнительныеРеквизитыИСведения.НайтиПоРеквизиту("Имя", "ПричинаОтменыБУС"); 
		
		Если ЗначениеЗаполнено(СвойствоПричинаОтмены) 
			И НЕ ЗначениеЗаполнено(УправлениеСвойствами.ЗначениеСвойства(ДанныеОбъект.Ссылка, СвойствоПричинаОтмены)) Тогда  	
		
			МнЗ = РегистрыСведений.ДополнительныеСведения.СоздатьМенеджерЗаписи();
			МнЗ.Объект = ДанныеОбъект.Ссылка;
			МнЗ.Свойство = СвойствоПричинаОтмены;   
			МнЗ.Значение = ОсновнаяПричинаОтмены;
			МнЗ.Записать();
		КонецЕсли;
		 	
	
	КонецЕсли; 
	             
	ДанныеОбъект.СкидкиРассчитаны = Истина;            
	ДанныеОбъект.СуммаДокумента = ДанныеОбъект.ПолучитьСуммуЗаказанныхСтрок();     
	ДанныеОбъект.ЗаполнитьЭтапыГрафикаОплаты();
КонецПроцедуры
